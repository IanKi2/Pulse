### Спецификация сервера для симуляции игры

#### Основные параметры
1. **Игровое поле**:
   - Размер: от 10x10 до 1000x1000 клеток
   - Фиксируется при инициализации сервера
   - Координаты: (0, 0) в левом верхнем углу

2. **Игровой цикл**:
   - Тик: 1-5 секунд (настраивается)
   - Поддержка сидов для детерминированной генерации

---

#### Сущности мира
| Тип         | Кол-во          | Свойства                     | Поведение                  |
|-------------|-----------------|------------------------------|----------------------------|
| **Агент**   | 1               | Позиция, радиус обзора(5-1000(размеры карты)), направление | Управляется клиентом       |
| **NPC**     | 0-1000(но не более 30% свободного пространства)          | Позиция, ID                  | Автономное/хаотичное движение |
| **Ресурсы** | 0-1000(но не более 30% свободного пространства)          | Позиция                      | Исчезают после сбора       |
| **Препятствия** | 0-30% поля   | Позиция                      | Статичны, блокируют движение |

---

#### Механики взаимодействия
1. **Перемещение**:
   - Разрешено только на свободные клетки
   - Клетка считается свободной, если:
     - Нет препятствий
     - Нет других сущностей (кроме ресурсов)
   - Ресурсы **не** блокируют движение

2. **Атака**:
   - Агент может атаковать NPC в радиусе обзора
   - NPC уничтожается одним попаданием

3. **Сбор ресурсов**:
   - Автоматически при нахождении агента в клетке с ресурсом
   - Ресурс исчезает, игроку начисляются очки

4. **Столкновение с препятствием**:
   - Агент мгновенно респавнится в случайной точке
   - Штраф: -10 очков за респавн

---

#### Данные для клиента
- **Состояние агента**:
  - Текущие очки (score)
  - Количество респавнов
- **Видимые сущности** (в радиусе обзора):
  - NPC (ID, позиция)
  - Ресурсы (позиция)
  - Препятствия (позиция)

---

### Спецификация модуля генерации мира

#### Входные параметры
| Параметр             | Ограничения                  |
|----------------------|------------------------------|
| `field_size`         | 10-1000                      |
| `obstacle_percent`   | 0-30% от поля                |
| `npc_count`          | ≤30% клеток                  |
| `resource_count`     | ≤30% клеток                  |
| `agent_vision_radius`| 5 до field_size              |
| `seed` (опц.)        | Любое целое                  |

#### Выходные данные
Двумерный массив объектов `Cell`:
```python
class Cell:
    x: int           # Координата X
    y: int           # Координата Y
    entity: dict     # Сущность на клетке или None
```

#### Формат сущностей
Тип | Структура
----|----------
**Пустая клетка** | `{"x": self.x, "y": self.y, "kind": "empty", "is_passable": True}`
**Препятствие** | `{"x": self.x, "y": self.y, "kind": "obstacle", "is_passable": False}`
**Агент** | `{"x": self.x, "y": self.y, "kind": "agent", "is_passable": False}`
**NPC** | `{"x": self.x, "y": self.y, "kind": "npc", "is_passable": False}`
**Ресурс** | `{"x": self.x, "y": self.y, "kind": "resourc", "is_passable": True}`

#### Процесс генерации
1. **Инициализация**:
   - Создание генератора Perlin noise с сидом
   - Рассчет масштаба: `scale = field_size / 10`

2. **Карта препятствий**:
   ```python
   for x,y in field:
       value = noise([x/scale, y/scale])
       is_obstacle = value > (100 - obstacle_percent) процентиль
   ```

3. **Создание клеток**:
   - Инициализация `WorldCell(x, y)`
   - Установка `is_obstacle` из карты

4. **Размещение сущностей**
   - Размещение нпс
   - Размещение ресурсов
   - Размещение агента

#### Правила размещения
1. Агент всегда размещается первым на свободной клетке
2. NPC размещаются только на свободных клетках
3. Ресурсы могут размещаться поверх NPC/агента
4. Препятствия генерируются до размещения сущностей

#### Зависимости
- `perlin-noise`: Генерация шума
- `numpy`: Обработка матриц

---

### API Endpoints
#### 1. Инициализация игры
**Endpoint**: `POST /init`  
**Тело запроса**:
```json
{
  "field_size": 50,
  "tick_interval": 3,
  "seed": 12345,
  "npc_count": 100,
  "resource_count": 200,
  "obstacle_percent": 15,
  "npc_movement": true,
  "agent_vision_radius": 5
}
```
**Ответ**: `HTTP 200 OK`  
**Ошибки**:
- `400`: Невалидные параметры
- `409`: Игра уже инициализирована

---

#### 2. Получение полного состояния (админ)
**Endpoint**: `GET /full-state`  
**Ответ**:
```json
{
  "agent": {"x": 10, "y": 5, "score": 42, "respawns": 2},
  "npcs": [{"id": 1, "x": 15, "y": 20}, ...],
  "resources": [{"x": 7, "y": 3}, ...],
  "obstacles": [{"x": 5, "y": 5}, ...]
}
```
**Ошибки**:
- `404`: Игра не инициализирована

---

#### 3. Отправка команд
**Endpoint**: `POST /command`  
**Тело запроса**:
```json
{
  "command": "move",
  "direction": "left"
}
```
**Возможные команды**:
- `move` (направления: up/down/left/right)
- `attack` (направления: up/down/left/right)

**Ответ**:
```json
{
  "status": "success",
  "visible_entities": {
    "npcs": [{"id": 1, "x": 12, "y": 5}],
    "resources": [{"x": 8, "y": 5}],
    "obstacles": []
  },
  "agent": {"x": 10, "y": 5, "score": 45, "respawns": 2}
}
```
### Обработка ошибок
| Код | Ситуация                          |
|-----|-----------------------------------|
| 400 | Невалидные параметры запроса      |
| 403 | Действие запрещено                |
| 404 | Ресурс не найден                  |
| 409 | Конфликт состояния (блокировка)   |
| 418 | Технические работы, Я чайник      |
| 500 | Внутренняя ошибка сервера         |

---

#### 4. Статус сервера
**Endpoint**: `GET /status`  

**Ответ**: 
```json
{
  "status": "ok",
  "service": "game-server",
  "game_initialized": "False"
}
```  
```json
{
  "status": "ok",
  "service": "game-server",
  "parameters": {
    "status": "initialized",
    "field_size": 50,
    "tick_interval": 3,
    "seed": 12345,
    "npc_count": 100,
    "resource_count": 200,
    "obstacle_percent": 15,
    "npc_movement": true,
    "agent_vision_radius": 5
  }
}
```  

---
